{"version":3,"sources":["../src/Changes.js"],"names":[],"mappings":"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","file":"Changes.js","sourcesContent":["import _debug from 'debug';\nimport { inspect } from 'util';\nimport { tryCatch } from 'rxjs/util/tryCatch';\nimport { errorObject } from 'rxjs/util/errorObject';\nimport { default as pathSyntax } from 'falcor-path-syntax';\nimport { Observable, Subscriber, Subscription } from 'rxjs';\n\nconst  { isArray } = Array;\n\nexport class Changes extends Observable {\n    constructor(subscribe) {\n        super(subscribe);\n        this.nextVal = null;\n        this.errorVal = null;\n        this.hasValue = false;\n        this.hasError = false;\n        this.subscribers = [];\n        this.subscription = null;\n        this.hasCompleted = false;\n    }\n    static from(source, component, indent = '') {\n        const changes = new Changes();\n        changes.debug = _debug(`reaxtor:changes`);\n        changes.source = source;\n        changes.indent = indent;\n        changes.component = component;\n        return changes;\n    }\n    lift(operator) {\n        const changes = new Changes();\n        changes.source = this;\n        changes.debug = this.debug;\n        changes.operator = operator;\n        changes.indent = this.indent;\n        changes.component = this.component;\n        return changes;\n    }\n    next(x) {\n        this.nextVal = x;\n        this.hasValue = true;\n        const subscribers = this.subscribers.slice(0);\n        const len = subscribers.length;\n        let index = -1;\n        while (++index < len) {\n            subscribers[index].next(x);\n        }\n    }\n    error(e) {\n        this.errorVal = e;\n        this.hasError = true;\n        const subscribers = this.subscribers.slice(0);\n        this.subscribers = [];\n        const len = subscribers.length;\n        let index = -1;\n        while (++index < len) {\n            subscribers[index].error(e);\n        }\n    }\n    complete() {\n        this.hasCompleted = true;\n        const subscribers = this.subscribers.slice(0);\n        this.subscribers = [];\n        const len = subscribers.length;\n        let index = -1;\n        while (++index < len) {\n            subscribers[index].complete();\n        }\n    }\n    _subscribe(subscriber) {\n\n        const { subscribers } = this;\n\n        subscribers.push(subscriber);\n\n        if (subscribers.length === 1) {\n            this.subscription = this.source.subscribe(this);\n        } else if (this.hasError) {\n            subscriber.error(this.errorVal);\n        } else if (this.hasCompleted) {\n            subscriber.complete();\n        } else if (this.hasValue) {\n            subscriber.next(this.nextVal);\n        }\n\n        return new Subscription(() => {\n            const index = subscribers.indexOf(subscriber);\n            if (~index) { subscribers.splice(index, 1); }\n            if (subscribers.length === 0) {\n                const subscription = this.subscription;\n                this.subscription = null;\n                subscription.unsubscribe();\n            }\n        });\n    }\n    deref(...keys) {\n        if (keys.length === 1) {\n            if (isArray(keys[0])) {\n                keys = keys[0];\n            } else if(typeof keys[0] === 'string') {\n                keys = pathSyntax(keys[0]);\n            }\n        }\n        return this.lift(new DerefOperator(keys, this.debug, this.indent, this.component));\n    }\n}\n\nclass DerefOperator {\n    constructor(keys, debug, indent, component) {\n        this.keys = keys;\n        this.debug = debug;\n        this.indent = indent;\n        this.component = component;\n    }\n    call(subscriber, source) {\n        return source._subscribe(new DerefSubscriber(subscriber,\n                                                     this.keys, this.debug,\n                                                     this.indent, this.component));\n    }\n}\n\nclass DerefSubscriber extends Subscriber {\n    constructor(destination, keys, debug, indent, component) {\n        super(destination);\n        this.keys = keys;\n        this.debug = debug;\n        this.indent = indent;\n        this.component = component;\n    }\n    _next(modelAndState = []) {\n\n        const { debug } = this;\n        const keys = this.keys;\n        const count = keys.length - 1;\n        let [ model, state ] = modelAndState;\n        let keysIdx = -1;\n\n        while (++keysIdx <= count) {\n\n            const key = keys[keysIdx];\n\n            if (state == null || typeof state !== 'object' || !state.hasOwnProperty(key)) {\n                const _path = model._path.concat(keys.slice(keysIdx));\n                if (debug.enabled) {\n                    debug.color = 'black';\n                    debug.log = console.warn.bind(console);\n                    const { indent } = this;\n                    debug(`      cache miss ${indent} ${this.component.key}`);\n                    (model._path.length > 0) &&\n                    debug(`            from ${indent} ${JSON.stringify(model._path)}`);\n                    debug(`       attempted ${indent} ${JSON.stringify(_path)}`);\n                }\n                model = model._clone({ _path });\n                break;\n            }\n\n            const tmpState = state[key];\n            const tmpModel = tryCatch(model.deref).call(model, tmpState);\n            if (tmpModel === errorObject) {\n                if (debug.enabled) {\n                    debug.color = 'black';\n                    debug.log = console.warn.bind(console);\n                    const { e } = errorObject;\n                    const { indent } = this;\n                    debug(`           error ${indent} ${e && e.message || e}\n                                          component ${indent} ${this.component.key} ${(model._path.length > 0) ? `\n                                               from ${indent} ${JSON.stringify(model._path)}` : ''}\n                                          attempted ${indent} ${JSON.stringify(model._path.concat(keys.slice(keysIdx)))}\n                                               data ${indent} ${inspect(tmpState, { depth: null })}\n                                             parent ${indent} ${inspect(state, { depth: null })}\\n`,\n                        e && e.stack || e\n                    );\n                }\n                return this.destination.error(errorObject.e);\n            }\n\n            state = tmpState;\n            model = tmpModel;\n        }\n\n        modelAndState[0] = model;\n        modelAndState[1] = state;\n\n        super._next(modelAndState);\n    }\n}\n"]}