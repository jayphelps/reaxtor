{"version":3,"sources":["../src/Changes.js"],"names":[],"mappings":"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","file":"Changes.js","sourcesContent":["import pad from 'left-pad';\nimport _debug from 'debug';\nimport { inspect } from 'util';\nimport { tryCatch } from 'rxjs/util/tryCatch';\nimport { errorObject } from 'rxjs/util/errorObject';\nimport { default as pathSyntax } from 'falcor-path-syntax';\nimport { Observable, Subscriber, Subscription } from 'rxjs';\n\nconst  { isArray } = Array;\n\nexport class Changes extends Observable {\n    constructor(subscribe) {\n        super(subscribe);\n        this.nextVal = null;\n        this.errorVal = null;\n        this.hasValue = false;\n        this.hasError = false;\n        this.subscribers = [];\n        this.subscription = null;\n        this.hasCompleted = false;\n    }\n    static from(source, component, depth = 0) {\n        const changes = new Changes();\n        changes.debug = _debug(`reaxtor:changes`);\n        changes.source = source;\n        changes.depth = depth;\n        changes.component = component;\n        return changes;\n    }\n    next(x) {\n        this.nextVal = x;\n        this.hasValue = true;\n        const subscribers = this.subscribers.slice(0);\n        const len = subscribers.length;\n        let index = -1;\n        while (++index < len) {\n            subscribers[index].next(x);\n        }\n    }\n    error(e) {\n        this.errorVal = e;\n        this.hasError = true;\n        const subscribers = this.subscribers.slice(0);\n        this.subscribers = [];\n        const len = subscribers.length;\n        let index = -1;\n        while (++index < len) {\n            subscribers[index].error(e);\n        }\n    }\n    complete() {\n        this.hasCompleted = true;\n        const subscribers = this.subscribers.slice(0);\n        this.subscribers = [];\n        const len = subscribers.length;\n        let index = -1;\n        while (++index < len) {\n            subscribers[index].complete();\n        }\n    }\n    _subscribe(subscriber) {\n\n        const { subscribers } = this;\n\n        subscribers.push(subscriber);\n\n        if (subscribers.length === 1) {\n            this.subscription = this.source.subscribe(this);\n        } else if (this.hasError) {\n            subscriber.error(this.errorVal);\n        } else if (this.hasCompleted) {\n            subscriber.complete();\n        } else if (this.hasValue) {\n            subscriber.next(this.nextVal);\n        }\n\n        return new Subscription(() => {\n            const index = subscribers.indexOf(subscriber);\n            if (~index) { subscribers.splice(index, 1); }\n            if (subscribers.length === 0) {\n                const subscription = this.subscription;\n                this.subscription = null;\n                subscription.unsubscribe();\n            }\n        });\n    }\n    deref(...keys) {\n        if (keys.length === 1) {\n            if (isArray(keys[0])) {\n                keys = keys[0];\n            } else if(typeof keys[0] === 'string') {\n                keys = keys[0].length === 0 ? keys[0] : pathSyntax(keys[0]);\n            }\n        }\n        return (keys.length === 0 ? this : this\n            .lift(new DerefOperator(keys, this.debug, this.depth, this.component))\n        );\n    }\n}\n\nclass DerefOperator {\n    constructor(keys, debug, depth, component) {\n        this.keys = keys;\n        this.debug = debug;\n        this.depth = depth;\n        this.component = component;\n    }\n    call(subscriber, source) {\n        return source._subscribe(new DerefSubscriber(subscriber,\n                                                     this.keys, this.debug,\n                                                     this.depth, this.component));\n    }\n}\n\nclass DerefSubscriber extends Subscriber {\n    constructor(destination, keys, debug, depth, component) {\n        super(destination);\n        this.keys = keys;\n        this.debug = debug;\n        this.depth = depth;\n        this.component = component;\n    }\n    warn(message, ...values) {\n        const { depth, debug } = this;\n        if (debug.enabled) {\n            debug.color = 'black';\n            debug.log = console.warn.bind(console);\n            debug(`${pad(message, 10 + (depth * 4))} |---- ${values.join(' ')}`);\n        }\n        return values[values.length - 1];\n    }\n    _next(update) {\n\n        const keys = this.keys;\n        const count = keys.length - 1;\n        let [ model, state ] = update;\n        let keysIdx = -1;\n\n        while (++keysIdx <= count) {\n\n            const key = keys[keysIdx];\n\n            if (state == null || typeof state !== 'object' || !state.hasOwnProperty(key)) {\n                const _path = model._path.concat(keys.slice(keysIdx));\n                this.warn(`cache miss`, this.component.key);\n                if (model._path.length > 0) {\n                    this.warn(`from`, JSON.stringify(model._path));\n                }\n                this.warn(`attempted`, JSON.stringify(_path));\n                model = model._clone({ _path });\n                break;\n            }\n\n            const tmpState = state[key];\n            const tmpModel = tryCatch(model.deref).call(model, tmpState);\n            if (tmpModel === errorObject) {\n                const { e } = errorObject;\n                this.warn('error', e && e.message || e);\n                this.warn('component', this.component.key);\n                if (model._path.length > 0) {\n                    this.warn('from', JSON.stringify(model._path));\n                }\n                this.warn('attempted', JSON.stringify(model._path.concat(keys.slice(keysIdx))));\n                this.warn('data', inspect(tmpState, { depth: null }));\n                this.warn('parent', inspect(state, { depth: null }));\n                this.warn('stack', e && e.stack || e);\n                return this.destination.error(errorObject.e);\n            }\n\n            state = tmpState;\n            model = tmpModel;\n        }\n\n        super._next([model, state]);\n    }\n}\n"]}